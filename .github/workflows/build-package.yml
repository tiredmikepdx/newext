name: Build Windows Package

on:
  workflow_dispatch:  # Allow manual trigger
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'package.json'
      - 'manifest.json'
      - 'tsconfig.json'

jobs:
  build-windows-package:
    name: Build .mcpb Package for Windows
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build TypeScript
        run: npm run build

      - name: Install mcpb CLI
        run: npm install -g @anthropic-ai/mcpb

      - name: Validate manifest
        run: mcpb validate manifest.json

      - name: Create .mcpb package
        run: mcpb pack . bambu-studio-mcp.mcpb

      - name: Verify package
        shell: pwsh
        run: |
          if (Test-Path bambu-studio-mcp.mcpb) {
            Write-Host "âœ“ Package created successfully"
            $size = (Get-Item bambu-studio-mcp.mcpb).Length
            Write-Host "Package size: $([math]::Round($size/1MB, 2)) MB"
          } else {
            Write-Error "âœ— Package creation failed"
            exit 1
          }

      - name: Test server from package
        shell: pwsh
        run: |
          # Create temp directory
          $testDir = Join-Path $env:TEMP "test-package"
          New-Item -ItemType Directory -Force -Path $testDir | Out-Null

          # Unpack the package
          mcpb unpack bambu-studio-mcp.mcpb $testDir

          # Test the server
          Push-Location $testDir
          $job = Start-Job -ScriptBlock { node dist/index.js 2>&1 }
          Start-Sleep -Seconds 3
          $output = Receive-Job -Job $job
          Stop-Job -Job $job
          Remove-Job -Job $job
          Pop-Location

          if ($output -match "Bambu Studio MCP Server running") {
            Write-Host "âœ“ Server from package works correctly"
          } else {
            Write-Error "âœ— Server test failed"
            exit 1
          }

      - name: Upload .mcpb package
        uses: actions/upload-artifact@v4
        with:
          name: bambu-studio-mcp-windows
          path: bambu-studio-mcp.mcpb
          retention-days: 30

      - name: Upload build summary
        shell: pwsh
        run: |
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "## Build Summary"
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value ""
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "âœ“ TypeScript compiled successfully"
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "âœ“ Manifest validated"
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "âœ“ .mcpb package created"
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "âœ“ Server tested and working"
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value ""
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "### Package Info"
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value '```'
          $fileInfo = Get-Item bambu-studio-mcp.mcpb
          $sizeInMB = [math]::Round($fileInfo.Length/1MB, 2)
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "$($fileInfo.Name) - $sizeInMB MB"
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value '```'
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value ""
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "ðŸ“¦ Download the .mcpb package from the workflow artifacts."
