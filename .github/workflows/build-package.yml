name: Build Windows Package

on:
  workflow_dispatch:  # Allow manual trigger
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'package.json'
      - 'manifest.json'
      - 'tsconfig.json'

jobs:
  build-windows-package:
    name: Build .mcpb Package for Windows
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Build TypeScript
      run: npm run build
    
    - name: Install mcpb CLI
      run: npm install -g @anthropic-ai/mcpb
    
    - name: Validate manifest
      run: mcpb validate manifest.json
    
    - name: Create .mcpb package
      run: mcpb pack . bambu-studio-mcp.mcpb
    
    - name: Verify package
      shell: bash
      run: |
        if [ -f bambu-studio-mcp.mcpb ]; then
          echo "âœ“ Package created successfully"
          SIZE=$(ls -lh bambu-studio-mcp.mcpb | awk '{print $5}')
          echo "Package size: $SIZE"
        else
          echo "âœ— Package creation failed"
          exit 1
        fi
    
    - name: Test server from package
      shell: bash
      run: |
        # Create temp directory
        mkdir -p /tmp/test-package
        
        # Unpack the package
        mcpb unpack bambu-studio-mcp.mcpb /tmp/test-package
        
        # Test the server
        cd /tmp/test-package
        timeout 3 node dist/index.js 2>&1 | grep -q "Bambu Studio MCP Server running" || \
        (timeout 3 node dist/index.js 2>&1 || true) | grep "Bambu Studio MCP Server running"
        
        echo "âœ“ Server from package works correctly"
    
    - name: Upload .mcpb package
      uses: actions/upload-artifact@v4
      with:
        name: bambu-studio-mcp-windows
        path: bambu-studio-mcp.mcpb
        retention-days: 30
    
    - name: Upload build summary
      shell: bash
      run: |
        echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ“ TypeScript compiled successfully" >> $GITHUB_STEP_SUMMARY
        echo "âœ“ Manifest validated" >> $GITHUB_STEP_SUMMARY
        echo "âœ“ .mcpb package created" >> $GITHUB_STEP_SUMMARY
        echo "âœ“ Server tested and working" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Package Info" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        ls -lh bambu-studio-mcp.mcpb >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“¦ Download the .mcpb package from the workflow artifacts." >> $GITHUB_STEP_SUMMARY
